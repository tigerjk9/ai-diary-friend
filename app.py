import streamlit as st
from openai import OpenAI
import os
from dotenv import load_dotenv

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'chat_history' not in st.session_state:
    st.session_state.chat_history = []

def analyze_diary(content):
    try:
        # OpenAI APIë¥¼ ì‚¬ìš©í•œ ê°ì • ë¶„ì„
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì¼ê¸°ì˜ ê°ì •ì„ ë¶„ì„í•˜ëŠ” AIì…ë‹ˆë‹¤. 'ì¢‹ìŒ', 'ë³´í†µ', 'ë‚˜ì¨' ì¤‘ í•˜ë‚˜ë¡œë§Œ ëŒ€ë‹µí•´ì£¼ì„¸ìš”."},
                {"role": "user", "content": f"ë‹¤ìŒ ì¼ê¸°ì˜ ê°ì •ì„ ë¶„ë¥˜í•´ì£¼ì„¸ìš”:\n\n{content}"}
            ]
        )
        emotion = response.choices[0].message.content.strip()

        # ê°ì •ì— ë”°ë¥¸ ìƒ‰ìƒ ì§€ì •
        color = {'ì¢‹ìŒ': '#4CAF50', 'ë³´í†µ': '#FFC107', 'ë‚˜ì¨': '#F44336'}.get(emotion, '#9E9E9E')

        # AI í”¼ë“œë°± ìƒì„±
        feedback_response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì´ˆ, ì¤‘í•™ìƒì„ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ì‚¬íšŒì •ì„œ ì§€ì› AIì…ë‹ˆë‹¤. ì¹œê·¼í•˜ê³  ë°ì€ í†¤ìœ¼ë¡œ ëŒ€í™”í•˜ë©°, ì´ëª¨í‹°ì½˜ì„ ë§ì´ ì‚¬ìš©í•˜ì„¸ìš”. í•™ìƒë“¤ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ê³µê°í•˜ë©°, ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì „ë‹¬í•´ì£¼ì„¸ìš”."},
                {"role": "user", "content": f"ë‹¤ìŒ ì¼ê¸°ì— ëŒ€í•´ í”¼ë“œë°±ì„ í•´ì£¼ì„¸ìš”:\n\n{content}"}
            ]
        )
        feedback = feedback_response.choices[0].message.content.strip()

        return emotion, color, feedback
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        return None, None, None

def chat_with_ai(message):
    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì´ˆ, ì¤‘í•™ìƒì„ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ì‚¬íšŒì •ì„œ ì§€ì› AIì…ë‹ˆë‹¤. ì¹œê·¼í•˜ê³  ë°ì€ í†¤ìœ¼ë¡œ ëŒ€í™”í•˜ë©°, ì´ëª¨í‹°ì½˜ì„ ë§ì´ ì‚¬ìš©í•˜ì„¸ìš”. í•™ìƒë“¤ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ê³µê°í•˜ë©°, ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì „ë‹¬í•´ì£¼ì„¸ìš”."},
                {"role": "user", "content": message}
            ]
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        return None

st.title('AI ì¼ê¸° ì¹œêµ¬ ğŸ¤–ğŸ“”')

st.write("""
AI ì¼ê¸° ì¹œêµ¬ëŠ” ì—¬ëŸ¬ë¶„ì˜ ì¼ê¸°ë¥¼ ë¶„ì„í•˜ê³  ê°ì •ì„ ì´í•´í•˜ì—¬ ë”°ëœ»í•œ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤. 
ì¼ê¸°ë¥¼ ì‘ì„±í•˜ê³  'ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, AIê°€ ì—¬ëŸ¬ë¶„ì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
ê·¸ í›„ AIì™€ ì¶”ê°€ë¡œ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š
""")

diary_content = st.text_area("ì˜¤ëŠ˜ì˜ ì¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:", height=200)

if st.button('ë¶„ì„í•˜ê¸°'):
    with st.spinner('AIê°€ ì—´ì‹¬íˆ ë¶„ì„ ì¤‘ì´ì—ìš”... ğŸ¤”'):
        emotion, color, feedback = analyze_diary(diary_content)
    
    if emotion and color and feedback:
        st.subheader('ê°ì • ë¶„ì„ ê²°ê³¼')
        st.markdown(f"<p style='color:{color};font-size:20px;'>ê°ì •: {emotion}</p>", unsafe_allow_html=True)
        
        st.subheader('AI í”¼ë“œë°±')
        st.info(feedback)
        
        st.session_state.chat_history = []
        st.session_state.chat_history.append(("AI", feedback))

if 'chat_history' in st.session_state and st.session_state.chat_history:
    st.subheader('AIì™€ ëŒ€í™”í•˜ê¸°')
    for i in range(3):
        user_message = st.text_input(f"ë©”ì‹œì§€ {i+1}", key=f"user_input_{i}")
        if user_message:
            st.session_state.chat_history.append(("User", user_message))
            ai_response = chat_with_ai(user_message)
            if ai_response:
                st.session_state.chat_history.append(("AI", ai_response))
    
    st.subheader('ëŒ€í™” ë‚´ìš©')
    for role, message in st.session_state.chat_history:
        if role == "User":
            st.text_input("You:", message, disabled=True)
        else:
            st.info(message)
